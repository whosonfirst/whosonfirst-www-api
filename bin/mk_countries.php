<?php

	include("init_local.php");
	loadlib("whosonfirst_places");
	loadlib("api_whosonfirst_utils");

	$_REQUEST['placetype'] = 'country';
	$filters = api_whosonfirst_utils_search_filters();

	$args = array(
		'per_page' => 500
	);

	$php = '<' . '?php';
	$now = date('Y-m-d H:i:s');

	$head = <<<END
$php

	# this file was also generated by robots on $now
	# https://github.com/whosonfirst/whosonfirst-www-api/blob/master/bin/mk_countries.php
	# https://github.com/whosonfirst/whosonfirst-www-api/blob/master/Makefile

	########################################################################

	\$GLOBALS['whosonfirst_countries'] = array(

END;

	$fh = fopen('www/include/lib_whosonfirst_countries.php', 'w');
	fwrite($fh, $head);

	$countries = array();
	$rsp = whosonfirst_places_search('', $filters, $args);
	foreach ($rsp['rows'] as $place) {
		$esc_id = intval($place['wof:id']);
		$esc_name = addslashes($place['wof:name']);
		$esc_code = addslashes($place['iso:country']);
		$countries[$esc_code] = array(
			'wof:id' => $esc_id,
			'wof:name' => $place['wof:name']
		);
		$country = <<<END
		'{$esc_code}' => array(
			'wof:id' => $esc_id,
			'wof:name' => '$esc_name'
		),

END;
		fwrite($fh, $country);
	}

	$foot = <<<END
	);

	# the end
END;

	fwrite($fh, $foot);
	fclose($fh);

	$countries_json = json_encode($countries);
	file_put_contents('www/javascript/whosonfirst_countries.js', "var whosonfirst_countries = $countries_json;");
